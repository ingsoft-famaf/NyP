 {% extends "base.html" %}

{% block content %}
<div class="page-header">
		<h1 id = "headline">You are taking a quiz</h1>
</div>

<h2 id="question"></h2>
<div id="answers"></div>
<div id="button">  </div>
{% endblock %}

{% block custom_js %}

<script>
 $( document ).ready(function() {
    var quiz = {{ quiz | safe }}
    var questions = quiz.questions

    function format_button(qid) {
        return '<button class="submit" type="button" id="ok' + qid + '">OK</button>';
    }

    function format_checkbox(qid, id, text) {
        var template='<div class="funkyradio"><div class="funkyradio-success">' +
                    '<input type="checkbox" name="' + qid + '" id="' + id + '"/>' +
                    '<label for="' + id + '">' + text + '</label></div></div>';

        return template;
    }

     // jquery extend function
     $.extend({
         redirectPost: function(args)
         {
             var form = $("<form action='/quiz/corrected/'> {% csrf_token %} </form>");
             form.attr("method", "post");

             $.each( args, function( key, value ) {
                 var field = $('<input></input>');

                 field.attr("type", "hidden");
                 field.attr("name", key);
                 field.attr("value", value);

                 form.append(field);
             });
             $(form).appendTo('body').submit();
         }
     });

	   function change_template(question) {
		     $("#question").text(question.text);
		     $("#answers").text('');
		     $("#button").text('');
		     for (i in question.answers) {
			       var answer = question.answers[i]
			       var $answer_html = $(format_checkbox(question.id, answer.id, answer.text));
			       $("#answers").append($answer_html);
		     }
         var $button_html = $(format_button(question.id));
         $("#button").append($button_html);
	   }

	   function is_checked(qid, answers) {
		     $( "[name='" + qid + "']:checked" ).each(function() {
		         answers.push($(this).attr('id'));
		     });
	   }

     result = {
         'quiz_id': quiz.id,
         'answers': []
     };
	   function next_question(i) {
		     var question_result = {
			       'question_id': questions[i].id,
			       'answer_id': []
		     };

         result.answers.push(question_result);
         change_template(questions[i]);
         $("#ok" + questions[i].id).click(function() {
             is_checked(questions[i].id, result.answers[i].answer_id);
             console.log(result.answers[i].answers);
             if (i + 1 == questions.length) {
                 $.redirectPost(
                     {
                         'json' : JSON.stringify(result)
                     }
                 );
             } else {
                 next_question(i + 1);
             }
         });
	   }
	   next_question(0);

 });

</script>
{% endblock %}
